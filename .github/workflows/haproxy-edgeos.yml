name: HAProxy 2.4 â€“ MIPS64 Cross-Compile with Target OS Libraries (Bind Mount)

on:
  push:
    # Trigger only when this workflow YAML is updated
    paths:
      - .github/workflows/haproxy-edgeos.yml
  workflow_dispatch:
    inputs:
      git_repo:
        description: "Git repository URL to build"
        required: false
        default: "http://git.haproxy.org/git/haproxy-2.4.git"
        type: string

      linking:
        description: "Executable type"
        required: false
        default: "dynamic"
        type: choice
        options: [static, dynamic]

      target_os_url:
        description: "URL of the target OS image"
        required: false
        default: "https://dl.ui.com/firmwares/edgemax/3.0.1/ER-e300.v3.0.1.5862409.tar"
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential git pkg-config libpcre3-dev zlib1g-dev \
            gcc-mips64-linux-gnuabi64 g++-mips64-linux-gnuabi64 \
            squashfs-tools binutils curl

      - name: Download target OS image
        run: |
          echo "Downloading target OS image..."
          curl -L -o target_os.tar "${{ inputs.target_os_url }}"
          tar -xf target_os.tar vmlinux.tmp squashfs.tmp
          echo "Firmware downloaded."

      - name: Detect target CPU, ABI, and bitness from kernel
        id: detect
        run: |
          KERNEL=vmlinux.tmp
          if [ ! -f $KERNEL ]; then
            echo "Kernel file vmlinux.tmp not found, using defaults."
            echo "arch=MIPS64" >> $GITHUB_ENV
            echo "cpu_bits=64" >> $GITHUB_ENV
            echo "abi=n32" >> $GITHUB_ENV
          else
            ARCH=$(file $KERNEL | awk '{print $4}')
            BITS=$(file $KERNEL | awk '{print $2}' | sed 's/ELF//')
            ABI=$(readelf -h $KERNEL | grep Flags | awk '{print $2}')
            echo "Detected ARCH=$ARCH"
            echo "Detected BITS=$BITS"
            echo "Detected ABI=$ABI"
            echo "arch=$ARCH" >> $GITHUB_ENV
            echo "cpu_bits=$BITS" >> $GITHUB_ENV
            echo "abi=$ABI" >> $GITHUB_ENV
          fi

      - name: Mount target OS root filesystem (bind mount)
        run: |
          mkdir -p /mnt/target_root /tmp/target_root
          echo "Mounting squashfs.tmp as loop device..."
          sudo mount -o loop,ro squashfs.tmp /mnt/target_root
          sudo mount --bind /mnt/target_root /tmp/target_root
          echo "Target root filesystem available at /tmp/target_root"

      - name: Build HAProxy
        run: |
          git_repo="${{ inputs.git_repo }}"
          if [ -z "$git_repo" ]; then
            git_repo="http://git.haproxy.org/git/haproxy-2.4.git"
          fi

          linking="${{ inputs.linking }}"
          if [ -z "$linking" ]; then linking="dynamic"; fi

          # Determine cross-compiler triplet and CFLAGS based on ABI
          if [ "${{ env.abi }}" = "n32" ]; then
            TRIPLET=mips64-linux-gnuabin32
            CFLAGS="-mabi=n32"
          else
            TRIPLET=mips64-linux-gnuabi64
            CFLAGS="-mabi=64"
          fi

          LDFLAGS="$CFLAGS"
          if [ "$linking" = "static" ]; then
            LDFLAGS="$LDFLAGS -static"
          fi

          export CC=$TRIPLET-gcc
          export CXX=$TRIPLET-g++
          export CFLAGS
          export LDFLAGS

          SYSROOT=/tmp/target_root
          echo "Using sysroot: $SYSROOT"

          git clone "$git_repo" haproxy
          cd haproxy

          make -j$(nproc) \
            TARGET=linux-glibc \
            USE_ZLIB=1 \
            USE_PCRE=1 \
            USE_STATIC_PCRE=$( [ "$linking" = "static" ] && echo 1 || echo 0 ) \
            USE_OPENSSL=0 \
            CC="$CC --sysroot=$SYSROOT" \
            CFLAGS="$CFLAGS --sysroot=$SYSROOT" \
            LDFLAGS="$LDFLAGS --sysroot=$SYSROOT" || { echo "Build failed"; exit 1; }

          install -m 0755 haproxy ../haproxy-cross

      - name: Rename binary
        run: |
          if [ ! -f ../haproxy-cross ]; then
            echo "ERROR: haproxy-cross does not exist!"
            exit 1
          fi

          OUTPUT=haproxy-latest-${{ env.arch }}-cpu${{ env.cpu_bits }}-${{ env.abi }}-${{ inputs.linking }}
          mv ../haproxy-cross "$OUTPUT"
          echo "Built binary: $OUTPUT"

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: HAProxy latest (${{ env.arch }} ${{ env.cpu_bits }}-bit ${{ env.abi }})
          body: Automated HAProxy cross-compile from ${{ inputs.git_repo }}
          files: haproxy-latest-*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup mounts
        if: always()
        run: |
          sudo umount /tmp/target_root || true
          sudo umount /mnt/target_root || true
          echo "Cleanup complete."
