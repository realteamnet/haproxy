name: HAProxy 2.4 â€“ MIPS64 Cross-Compile on Ubuntu


on:
  workflow_dispatch:
    inputs:
      git_repo:
        description: "Git repository URL to build"
        required: false
        default: "http://git.haproxy.org/git/haproxy-2.4.git"
        type: string

      linking:
        description: "Executable type"
        required: false
        default: "dynamic"
        type: choice
        options: [static, dynamic]

      cpu_bits:
        description: "CPU bitness"
        required: false
        default: "64"
        type: choice
        options: ["64"]

      userland_bits:
        description: "Userland bitness"
        required: false
        default: "32"
        type: choice
        options: ["32", "64"]

      abi:
        description: "MIPS ABI"
        required: false
        default: "n32"
        type: choice
        options: [n32, n64]

      target_distro:
        description: "Target Linux distro"
        required: false
        default: "debian"
        type: choice
        options: [debian, ubuntu]

      target_release:
        description: "Target release (used for glibc/OpenSSL inference)"
        required: false
        default: "stretch"
        type: string

  push:
    paths:
      - ".github/workflows/haproxy-edgeos.yml"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Derive toolchain and flags
        id: vars
        run: |
          # Set cross-compiler triplet and CFLAGS based on ABI/userland
          if [ "${{ inputs.userland_bits }}" = "32" ] && [ "${{ inputs.abi }}" = "n32" ]; then
            echo "triplet=mips64-linux-gnuabin32" >> $GITHUB_OUTPUT
            echo "cflags=-mabi=n32" >> $GITHUB_OUTPUT
            echo "abi_suffix=n32" >> $GITHUB_OUTPUT
            echo "ul_bits=32" >> $GITHUB_OUTPUT
          else
            echo "triplet=mips64-linux-gnuabi64" >> $GITHUB_OUTPUT
            echo "cflags=-mabi=64" >> $GITHUB_OUTPUT
            echo "abi_suffix=n64" >> $GITHUB_OUTPUT
            echo "ul_bits=64" >> $GITHUB_OUTPUT
          fi

          # Linking flags
          linking="${{ inputs.linking }}"
          if [ -z "$linking" ]; then
            linking="dynamic"
          fi

          if [ "$linking" = "static" ]; then
            echo "ldflags=-static" >> $GITHUB_OUTPUT
            echo "link_suffix=static" >> $GITHUB_OUTPUT
          else
            echo "ldflags=" >> $GITHUB_OUTPUT
            echo "link_suffix=dynamic" >> $GITHUB_OUTPUT
          fi

      - name: Determine target library compatibility
        run: |
          # Map target distro/release to glibc/OpenSSL versions
          if [[ "${{ inputs.target_distro }}" == "debian" && "${{ inputs.target_release }}" == "stretch" ]]; then
            echo "TARGET_GLIBC=2.24" >> $GITHUB_ENV
            echo "TARGET_OPENSSL=1.1.0" >> $GITHUB_ENV
          elif [[ "${{ inputs.target_distro }}" == "ubuntu" && "${{ inputs.target_release }}" == "focal" ]]; then
            echo "TARGET_GLIBC=2.31" >> $GITHUB_ENV
            echo "TARGET_OPENSSL=1.1.1" >> $GITHUB_ENV
          else
            echo "TARGET_GLIBC=unknown" >> $GITHUB_ENV
            echo "TARGET_OPENSSL=unknown" >> $GITHUB_ENV
          fi
          echo "Inferred TARGET_GLIBC=$TARGET_GLIBC, TARGET_OPENSSL=$TARGET_OPENSSL"

      - name: Install cross-compiler and dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            git \
            pkg-config \
            libpcre3-dev \
            zlib1g-dev \
            gcc-mips64-linux-gnuabi64 \
            g++-mips64-linux-gnuabi64

          # For n32 ABI
          if [ "${{ inputs.userland_bits }}" = "32" ] && [ "${{ inputs.abi }}" = "n32" ]; then
            sudo apt-get install -y gcc-mips64-linux-gnuabin32 g++-mips64-linux-gnuabin32
          fi

      - name: Build HAProxy
        run: |
          git_repo="${{ inputs.git_repo }}"
          if [ -z "$git_repo" ]; then
            git_repo="http://git.haproxy.org/git/haproxy-2.4.git"
          fi

          linking="${{ inputs.linking }}"
          if [ -z "$linking" ]; then
            linking="dynamic"
          fi

          export CC=${{ steps.vars.outputs.triplet }}-gcc
          export CXX=${{ steps.vars.outputs.triplet }}-g++
          export CFLAGS="${{ steps.vars.outputs.cflags }}"
          export LDFLAGS="${{ steps.vars.outputs.cflags }} ${{ steps.vars.outputs.ldflags }}"

          git clone "$git_repo" haproxy
          cd haproxy

          make -j$(nproc) \
            TARGET=linux-glibc \
            USE_ZLIB=1 \
            USE_PCRE=1 \
            USE_STATIC_PCRE=$( [ "$linking" = "static" ] && echo 1 || echo 0 ) \
            USE_OPENSSL=0

          install -m 0755 haproxy ./haproxy-cross

      - name: Rename binary
        run: |
          mv haproxy-cross \
            haproxy-latest-linux-mips64-cpu${{ inputs.cpu_bits }}-ul${{ steps.vars.outputs.ul_bits }}-${{ steps.vars.outputs.abi_suffix }}-${{ steps.vars.outputs.link_suffix }}-${{ inputs.target_distro }}${{ inputs.target_release }}

      - name: Create or update GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: HAProxy latest (MIPS64 ${{ inputs.target_distro }} ${{ inputs.target_release }})
          body: |
            Automated HAProxy cross-compile from repository ${{ inputs.git_repo }}

            CPU bitness:      ${{ inputs.cpu_bits }}-bit
            Userland bitness: ${{ inputs.userland_bits }}-bit
            ABI:              ${{ inputs.abi }}
            Linking:          ${{ inputs.linking }}
            Target glibc:     ${{ env.TARGET_GLIBC }}
            Target OpenSSL:   ${{ env.TARGET_OPENSSL }}
          files: |
            haproxy-latest-linux-mips64-cpu${{ inputs.cpu_bits }}-ul${{ steps.vars.outputs.ul_bits }}-${{ steps.vars.outputs.abi_suffix }}-${{ steps.vars.outputs.link_suffix }}-${{ inputs.target_distro }}${{ inputs.target_release }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
