name: Compile for EdgeRouter 12

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Git tag to build (must be v2.2.0)'
        required: true
        default: 'v2.2.0'

permissions:
  contents: read

jobs:
  cross-compilation:
    runs-on: ubuntu-18.04
    if: ${{ github.event.inputs.tag == 'v2.2.0' }}

    strategy:
      matrix:
        variant:
          - name: mips64-k64-u64
            target_flags: "-static"       # Pure 64-bit userland
          - name: mips64-k64-u32
            target_flags: "-static -mabi=32"  # 32-bit userland, 64-bit kernel

    name: Build ${{ matrix.variant.name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.tag }}

      - name: Install cross-compiler
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-mips64-linux-gnuabi64

      - name: Set up environment
        run: |
          export CC=mips64-linux-gnuabi64-gcc
          export CFLAGS="${{ matrix.variant.target_flags }}"
          export LDFLAGS="${{ matrix.variant.target_flags }}"

      - name: Build HAProxy statically
        run: |
          make clean
          make \
            CC=${CC} \
            CFLAGS="${CFLAGS}" \
            LDFLAGS="${LDFLAGS}" \
            TARGET=linux-glibc \
            USE_OPENSSL=0 \
            USE_ZLIB=0 \
            USE_PCRE=0 \
            USE_SYSTEMD=0 \
            ADDLIB="" \
            V=1

      - name: Verify binary type
        run: |
          echo "Binary info:"
          file ./haproxy
          readelf -h ./haproxy | grep 'Class\|Data'

      - name: Upload static binary
        uses: actions/upload-artifact@v3
        with:
          name: haproxy-${{ matrix.variant.name }}-static
          path: ./haproxy
