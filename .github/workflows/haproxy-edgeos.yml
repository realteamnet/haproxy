name: HAProxy v2.2.34 Debian 9 MIPS64 Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: 

jobs:
  build-mips:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # n64 = 64-bit | n32 = High performance 32-bit (ABI2)
        abi: [n64, n32]

    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build HAProxy in Debian 9 Container
        run: |
          # Targeting mips64el (Little Endian). 
          docker run --rm -v ${{ github.workspace }}:/output debian/stretch-slim-mips64el:latest /bin/bash -c "
            # 1. Point to Archive Repos
            echo 'deb http://archive.debian.org/debian stretch main' > /etc/apt/sources.list && \
            echo 'Acquire::Check-Valid-Until \"false\";' > /etc/apt/apt.conf.d/99no-check-valid && \
            
            # 2. Install Build Dependencies
            # --- UNCOMMENT BELOW TO ENABLE LUA ---
            # apt-get update && apt-get install -y --force-yes build-essential git libpcre3-dev libssl-dev zlib1g-dev lua5.3 liblua5.3-dev && \
            apt-get update && apt-get install -y --force-yes build-essential git libpcre3-dev libssl-dev zlib1g-dev && \
            
            # 3. Pull directly from official HAProxy GitHub
            git clone --branch v2.2.34 --depth 1 https://github.com/haproxy/haproxy.git && \
            cd haproxy && \
            
            # 4. Compile
            # --- UNCOMMENT LUA LINES TO ENABLE ---
            make -j$(nproc) \
              TARGET=linux-glibc \
              CPU=generic \
              ARCH=mips64 \
              ADDLIB=\"-latomic\" \
              CFLAGS=\"-mabi=${{ matrix.abi }} -O2\" \
              LDFLAGS=\"-mabi=${{ matrix.abi }}\" \
              USE_PCRE=1 USE_OPENSSL=1 USE_ZLIB=1 && \
              # USE_LUA=1 \
              # LUA_LIB_NAME=lua5.3 && \
            
            # 5. Verify Build
            echo '--- VERIFICATION ---' && \
            file haproxy && \
            readelf -h haproxy | grep -E 'Class|Machine|Flags' && \
            
            # 6. Copy to output
            cp haproxy /output/haproxy-2.2.34-${{ matrix.abi }}
          "

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: haproxy-v2.2.34-mips64-${{ matrix.abi }}
          path: haproxy-2.2.34-${{ matrix.abi }}
