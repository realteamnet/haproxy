name: HAProxy Debian 9 MIPS64 Build

on:
  workflow_dispatch:
    inputs:
      haproxy_version:
        description: 'Select HAProxy Version'
        required: true
        default: '2.4.30' # Set as the new default
        type: choice
        options:
          - '2.4.30'  # Best balance of features and compatibility
          - '2.2.34'  # Legacy LTS (Max compatibility)
          - '2.0.31'  # Older LTS
  push:
    branches: [ main ]

jobs:
  build-mips:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        abi: [n64, n32]

    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build HAProxy in Debian 9 Container
        run: |
          docker run --rm -v ${{ github.workspace }}:/output debian/stretch-slim-mips64el:latest /bin/bash -c "
            # 1. Point to Archive Repos
            echo 'deb http://archive.debian.org/debian stretch main' > /etc/apt/sources.list && \
            echo 'Acquire::Check-Valid-Until \"false\";' > /etc/apt/apt.conf.d/99no-check-valid && \
            
            # 2. Install Build Dependencies
            apt-get update && apt-get install -y --force-yes build-essential git libpcre3-dev libssl-dev zlib1g-dev && \
            
            # 3. Clone and Checkout selected version
            git clone --branch v${{ github.event.inputs.haproxy_version || '2.4.30' }} --depth 1 https://github.com/haproxy/haproxy.git && \
            cd haproxy && \
            
            # 4. Compile with MIPS-specific flags
            # TARGET=linux-glibc is ideal for Debian 9's glibc 2.24
            make -j$(nproc) \
              TARGET=linux-glibc \
              CPU=generic \
              ARCH=mips64 \
              ADDLIB=\"-latomic\" \
              CFLAGS=\"-mabi=${{ matrix.abi }} -O2\" \
              LDFLAGS=\"-mabi=${{ matrix.abi }}\" \
              USE_PCRE=1 USE_OPENSSL=1 USE_ZLIB=1 && \
            
            # 5. Verify and Export
            echo '--- BINARY INFO ---' && \
            file haproxy && \
            readelf -h haproxy | grep -E 'Class|Machine|Flags' && \
            cp haproxy /output/haproxy-${{ github.event.inputs.haproxy_version || '2.4.30' }}-${{ matrix.abi }}
          "

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: haproxy-${{ github.event.inputs.haproxy_version || '2.4.30' }}-${{ matrix.abi }}
          path: haproxy-${{ github.event.inputs.haproxy_version || '2.4.30' }}-${{ matrix.abi }}
