# File: .github/workflows/build-mips.yml
name: Build HAProxy MIPS Binaries for EdgeRouter 12

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Git tag to build'
        required: true
        default: 'v2.2.0'

permissions:
  contents: read

jobs:
  cross-compilation:
    runs-on: ubuntu-18.04

    # Only run if the tag input matches v2.2.0
    if: ${{ github.event.inputs.tag == 'v2.2.0' }}

    strategy:
      matrix:
        platform:
          - arch: mips-linux-gnu
            libs: libc6-dev-mips-cross
            target: -static linux-mips32
          - arch: mips64-linux-gnuabi64
            libs: libc6-dev-mips64-cross
            target: -static linux64-mips64

    name: Build for ${{ matrix.platform.arch }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.inputs.tag }}

      - name: Install cross-compiler packages
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-${{ matrix.platform.arch }} \
            ${{ matrix.platform.libs }}

      - name: Set up environment
        run: |
          export CC=${{ matrix.platform.arch }}-gcc
          export TARGET="${{ matrix.platform.target }}"

      - name: Build HAProxy
        run: |
          make clean
          make \
            CC=${CC} \
            TARGET=linux-glibc \
            USE_OPENSSL=1 \
            USE_ZLIB=1 \
            USE_PCRE=1 \
            USE_SYSTEMD=0 \
            ADDLIB="-static" \
            V=1

      - name: Upload build artifacts
        uses: actions/upload-artifact@v3
        with:
          name: haproxy-${{ matrix.platform.arch }}
          path: ./haproxy
