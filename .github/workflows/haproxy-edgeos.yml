name: HAProxy Debian 9 MIPS64 Build

on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allows manual trigger without inputs

jobs:
  build-mips:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # n64 = 64-bit | n32 = Optimized 64-bit registers with 32-bit pointers
        abi: [n64, n32]

    steps:
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Build HAProxy in Debian 9 Container
        run: |
          # Use mips64el (Little Endian). Swap image to 'debian/stretch-slim-mips64' if Big Endian.
          docker run --rm -v ${{ github.workspace }}:/output debian/stretch-slim-mips64el:latest /bin/bash -c "
            # 1. Point to Archive Repos (Critical for Debian 9 EOL)
            echo 'deb http://archive.debian.org/debian stretch main' > /etc/apt/sources.list && \
            echo 'Acquire::Check-Valid-Until \"false\";' > /etc/apt/apt.conf.d/99no-check-valid && \
            
            # 2. Install Build Dependencies
            apt-get update && apt-get install -y --force-yes build-essential git libpcre3-dev libssl-dev zlib1g-dev && \
            
            # 3. Clone from Official git.haproxy.org (latest 2.4 branch)
            # Pulling the v2.4.30 tag specifically for the 'latest 2.4' requirement
            git clone --depth 1 --branch v2.4.30 http://git.haproxy.org/git/haproxy-2.4.git/ haproxy-src && \
            cd haproxy-src && \
            
            # 4. Compile with MIPS-specific flags
            make -j$(nproc) \
              TARGET=linux-glibc \
              CPU=generic \
              ARCH=mips64 \
              ADDLIB=\"-latomic\" \
              CFLAGS=\"-mabi=${{ matrix.abi }} -O2\" \
              LDFLAGS=\"-mabi=${{ matrix.abi }}\" \
              USE_PCRE=1 USE_OPENSSL=1 USE_ZLIB=1 && \
            
            # 5. Verify Architecture and Export
            echo '--- BINARY INFO ---' && \
            file haproxy && \
            readelf -h haproxy | grep -E 'Class|Machine|Flags' && \
            cp haproxy /output/haproxy-2.4.30-${{ matrix.abi }}
          "

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: haproxy-2.4.30-mips64-${{ matrix.abi }}
          path: haproxy-2.4.30-${{ matrix.abi }}
