name: HAProxy 2.4 â€“ MIPS64 (Cross-Compile in Debian Stretch Chroot)

on:
  workflow_dispatch:
    inputs:
      git_repo:
        description: "Git repository URL to build"
        required: true
        default: "http://git.haproxy.org/git/haproxy-2.4.git"
        type: string

      linking:
        description: "Executable type"
        required: true
        default: "dynamic"
        type: choice
        options: [static, dynamic]

      cpu_bits:
        description: "CPU bitness"
        required: true
        default: "64"
        type: choice
        options: ["64"]

      userland_bits:
        description: "Userland bitness"
        required: true
        default: "32"
        type: choice
        options: ["32", "64"]

      abi:
        description: "MIPS ABI"
        required: true
        default: "n32"
        type: choice
        options: [n32, n64]

      target_distro:
        description: "Target Linux distro for chroot"
        required: true
        default: "debian"
        type: choice
        options: [debian, ubuntu]

      target_release:
        description: "Distro release / glibc baseline"
        required: true
        default: "stretch"
        type: string

  push:
    paths:
      - ".github/workflows/haproxy-edgeos.yml"

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Validate CPU / userland / ABI
        run: |
          if [ "${{ inputs.cpu_bits }}" != "64" ]; then
            echo "ERROR: MIPS64 requires a 64-bit CPU"
            exit 1
          fi

          if [ "${{ inputs.userland_bits }}" = "32" ] && [ "${{ inputs.abi }}" != "n32" ]; then
            echo "ERROR: 32-bit userland requires n32 ABI"
            exit 1
          fi

          if [ "${{ inputs.userland_bits }}" = "64" ] && [ "${{ inputs.abi }}" != "n64" ]; then
            echo "ERROR: 64-bit userland requires n64 ABI"
            exit 1
          fi

      - name: Derive toolchain and flags
        id: vars
        run: |
          if [ "${{ inputs.userland_bits }}" = "32" ] && [ "${{ inputs.abi }}" = "n32" ]; then
            echo "triplet=mips64-linux-gnuabin32" >> $GITHUB_OUTPUT
            echo "cflags=-mabi=n32" >> $GITHUB_OUTPUT
            echo "abi_suffix=n32" >> $GITHUB_OUTPUT
            echo "ul_bits=32" >> $GITHUB_OUTPUT
          else
            echo "triplet=mips64-linux-gnuabi64" >> $GITHUB_OUTPUT
            echo "cflags=-mabi=64" >> $GITHUB_OUTPUT
            echo "abi_suffix=n64" >> $GITHUB_OUTPUT
            echo "ul_bits=64" >> $GITHUB_OUTPUT
          fi

          if [ "${{ inputs.linking }}" = "static" ]; then
            echo "ldflags=-static" >> $GITHUB_OUTPUT
            echo "link_suffix=static" >> $GITHUB_OUTPUT
          else
            echo "ldflags=" >> $GITHUB_OUTPUT
            echo "link_suffix=dynamic" >> $GITHUB_OUTPUT
          fi

      - name: Install host tools
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            git \
            debootstrap \
            build-essential \
            binutils \
            pkg-config \
            libpcre3-dev \
            zlib1g-dev

      - name: Create native chroot (Debian Stretch)
        run: |
          sudo debootstrap \
            --arch=amd64 \
            --variant=minbase \
            --no-check-gpg \
            ${{ inputs.target_release }} \
            rootfs \
            http://archive.debian.org/debian/

      - name: Disable expired Release checks inside chroot
        run: |
          sudo mkdir -p rootfs/etc/apt/apt.conf.d
          echo 'Acquire::Check-Valid-Until "false";' | sudo tee rootfs/etc/apt/apt.conf.d/99no-check-valid-until

      - name: Prepare chroot
        run: |
          sudo mount --bind /proc rootfs/proc
          sudo mount --bind /sys rootfs/sys
          sudo mount --bind /dev rootfs/dev

      - name: Cross-compile HAProxy inside chroot
        run: |
          sudo chroot rootfs /bin/bash -eux << EOF
          export DEBIAN_FRONTEND=noninteractive

          # Install cross-toolchain inside chroot
          apt-get update
          apt-get install -y git build-essential pkg-config libpcre3-dev zlib1g-dev

          if [ "${{ inputs.abi }}" = "n32" ]; then
            apt-get install -y gcc-mips64-linux-gnuabin32 g++-mips64-linux-gnuabin32
            export CC=mips64-linux-gnuabin32-gcc
            export CXX=mips64-linux-gnuabin32-g++
            export CFLAGS="-mabi=n32"
          else
            apt-get install -y gcc-mips64-linux-gnuabi64 g++-mips64-linux-gnuabi64
            export CC=mips64-linux-gnuabi64-gcc
            export CXX=mips64-linux-gnuabi64-g++
            export CFLAGS="-mabi=64"
          fi

          if [ "${{ inputs.linking }}" = "static" ]; then
            export LDFLAGS="-static"
          else
            export LDFLAGS=""
          fi

          git clone ${{ inputs.git_repo }} haproxy
          cd haproxy

          make -j\$(nproc) \
            TARGET=linux-glibc \
            USE_ZLIB=1 \
            USE_PCRE=1 \
            USE_STATIC_PCRE=$( [ "${{ inputs.linking }}" = "static" ] && echo 1 || echo 0 ) \
            USE_OPENSSL=0 \
            USE_LUA=0

          install -m 0755 haproxy /output-haproxy
          EOF

      - name: Copy binary out of chroot
        run: |
          sudo cp rootfs/output-haproxy ./haproxy

      - name: Create or update GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: HAProxy latest (MIPS64 ${{ inputs.target_distro }} ${{ inputs.target_release }})
          body: |
            Automated HAProxy cross-compile from repository ${{ inputs.git_repo }}

            CPU bitness:      ${{ inputs.cpu_bits }}-bit
            Userland bitness: ${{ inputs.userland_bits }}-bit
            ABI:              ${{ inputs.abi }}
            Linking:          ${{ inputs.linking }}
            Distro:           ${{ inputs.target_distro }} ${{ inputs.target_release }} (glibc)
          files: |
            haproxy
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Rename asset
        run: |
          mv haproxy \
            haproxy-latest-linux-mips64-cpu${{ inputs.cpu_bits }}-ul${{ steps.vars.outputs.ul_bits }}-${{ steps.vars.outputs.abi_suffix }}-${{ steps.vars.outputs.link_suffix }}-${{ inputs.target_distro }}${{ inputs.target_release }}

      - name: Upload renamed asset
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          files: |
            haproxy-latest-linux-mips64-cpu${{ inputs.cpu_bits }}-ul${{ steps.vars.outputs.ul_bits }}-${{ steps.vars.outputs.abi_suffix }}-${{ steps.vars.outputs.link_suffix }}-${{ inputs.target_distro }}${{ inputs.target_release }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Cleanup
        if: always()
        run: |
          sudo umount -lf rootfs/proc || true
          sudo umount -lf rootfs/sys || true
          sudo umount -lf rootfs/dev || true
